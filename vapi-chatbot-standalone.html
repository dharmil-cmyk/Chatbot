<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vapi Chatbot Integration</title>
</head>
<body>
    <!-- Your website content goes here -->
    <h1>Welcome to Your Website</h1>
    <p>This is a demo page showing how to integrate the Vapi chatbot.</p>

    <!-- Vapi Chatbot Integration -->
    <!-- Chat Launcher Button -->
    <button id="vapi-chat-launcher" aria-label="Open chat with assistant">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Chat with us</span>
    </button>

    <!-- Chat Window -->
    <div id="vapi-chat-window" role="dialog" aria-label="Chat with assistant" aria-hidden="true">
        <div class="chat-header">
            <div class="chat-title">
                <div class="status-indicator"></div>
                <span>Chat with Sara</span>
            </div>
            <button id="chat-close-btn" aria-label="Close chat">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <div id="chat-messages" class="chat-messages">
            <div class="welcome-message">
                <div class="assistant-avatar">ðŸ¤–</div>
                <div class="message-content">
                    <p>Welcome! I'm Sara, your AI assistant. How can I help you today?</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="input-container">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Type your message..." 
                    autocomplete="off"
                    aria-label="Type your message"
                />
                <button id="send-btn" aria-label="Send message" disabled>
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 10L18 2L11 10L18 18L2 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="chat-status" id="chat-status">
                <span class="typing-indicator" style="display: none;">Assistant is typing...</span>
            </div>
        </div>
    </div>

    <!-- Consent Modal -->
    <div id="consent-modal" role="dialog" aria-labelledby="consent-title" aria-hidden="true">
        <div class="consent-content">
            <h3 id="consent-title">Privacy Notice</h3>
            <p>By using this chat widget, you agree to our privacy policy and terms of service. Your conversations may be recorded for quality assurance and to improve our services.</p>
            <div class="consent-buttons">
                <button id="consent-agree" class="primary-btn">Accept & Continue</button>
                <button id="consent-decline" class="secondary-btn">Decline</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div id="chat-overlay"></div>

    <style>
        /* Chatbot Styles */
        :root {
            --chat-primary: #4c8697;
            --chat-primary-dark: #3a6b7a;
            --chat-secondary: #f8f9fa;
            --chat-text: #333;
            --chat-text-light: #666;
            --chat-border: #e1e5e9;
            --chat-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --chat-radius: 12px;
            --chat-z-launcher: 1000;
            --chat-z-window: 1001;
            --chat-z-modal: 1002;
        }

        /* Chat Launcher Button */
        #vapi-chat-launcher {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--chat-primary);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--chat-shadow);
            transition: all 0.3s ease;
            z-index: var(--chat-z-launcher);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        #vapi-chat-launcher:hover {
            background: var(--chat-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        #vapi-chat-launcher svg {
            flex-shrink: 0;
        }

        /* Chat Window */
        #vapi-chat-window {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 380px;
            height: 600px;
            max-height: calc(100vh - 48px);
            background: white;
            border-radius: var(--chat-radius);
            box-shadow: var(--chat-shadow);
            display: none;
            flex-direction: column;
            z-index: var(--chat-z-window);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }

        #vapi-chat-window.open {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat Header */
        .chat-header {
            background: var(--chat-primary);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #chat-close-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        #chat-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .welcome-message,
        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .assistant-avatar,
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .assistant-avatar {
            background: var(--chat-secondary);
        }

        .user-avatar {
            background: var(--chat-primary);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
        }

        .welcome-message .message-content,
        .message.assistant .message-content {
            background: var(--chat-secondary);
            color: var(--chat-text);
        }

        .message.user .message-content {
            background: var(--chat-primary);
            color: white;
        }

        /* Chat Input */
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--chat-border);
            background: white;
        }

        .input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        #chat-input {
            flex: 1;
            border: 1px solid var(--chat-border);
            border-radius: 24px;
            padding: 12px 16px;
            font-size: 14px;
            outline: none;
            resize: none;
            font-family: inherit;
        }

        #chat-input:focus {
            border-color: var(--chat-primary);
        }

        #send-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--chat-primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #send-btn:hover:not(:disabled) {
            background: var(--chat-primary-dark);
            transform: scale(1.05);
        }

        #send-btn:disabled {
            background: var(--chat-border);
            cursor: not-allowed;
            transform: none;
        }

        .chat-status {
            margin-top: 8px;
            font-size: 12px;
            color: var(--chat-text-light);
            min-height: 16px;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Consent Modal */
        #consent-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--chat-z-modal);
            padding: 20px;
        }

        #consent-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .consent-content {
            background: white;
            border-radius: var(--chat-radius);
            padding: 32px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .consent-content h3 {
            margin: 0 0 16px 0;
            color: var(--chat-text);
        }

        .consent-content p {
            margin: 0 0 24px 0;
            color: var(--chat-text-light);
            line-height: 1.5;
        }

        .consent-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .primary-btn,
        .secondary-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .primary-btn {
            background: var(--chat-primary);
            color: white;
            border: none;
        }

        .primary-btn:hover {
            background: var(--chat-primary-dark);
        }

        .secondary-btn {
            background: transparent;
            color: var(--chat-text);
            border: 1px solid var(--chat-border);
        }

        .secondary-btn:hover {
            background: var(--chat-secondary);
        }

        /* Overlay */
        #chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            z-index: calc(var(--chat-z-window) - 1);
        }

        #chat-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Mobile Responsiveness */
        @media (max-width: 480px) {
            #vapi-chat-window {
                width: calc(100vw - 20px);
                height: calc(100vh - 20px);
                bottom: 10px;
                right: 10px;
                border-radius: 12px;
            }

            #vapi-chat-launcher {
                bottom: 20px;
                right: 20px;
            }

            .chat-messages {
                padding: 16px;
            }

            .chat-input-area {
                padding: 16px;
            }
        }

        /* Hide launcher when chat is open */
        #vapi-chat-window.open ~ #vapi-chat-launcher {
            display: none;
        }
    </style>

    <script type="module">
        // Vapi Integration Configuration
        const VAPI_CONFIG = {
            publicKey: 'd9eda860-9c14-4a5c-9fed-c8a22a92d97a', // Replace with your public key
            assistantId: 'd92bbcef-0ce5-48fa-b7c7-575aae277838', // Replace with your assistant ID
            consentKey: 'vapi_widget_consent',
            welcomeMessage: "Welcome to the Neuro-Wellness Medical Homeâ„¢â€”where science meets self-care. I am Sara. Would you like help exploring services, joining our Men's Health program, or booking your first visit?"
        };

        // Import Vapi SDK
        let Vapi;
        try {
            const module = await import('https://cdn.skypack.dev/@vapi-ai/web');
            Vapi = module.default;
        } catch (error) {
            console.error('Failed to load Vapi SDK:', error);
            alert('Chat service is currently unavailable. Please try again later.');
        }

        // Chat Manager Class
        class VapiChatManager {
            constructor(config) {
                this.config = config;
                this.vapi = null;
                this.isSessionActive = false;
                this.elements = this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                return {
                    launcher: document.getElementById('vapi-chat-launcher'),
                    chatWindow: document.getElementById('vapi-chat-window'),
                    closeBtn: document.getElementById('chat-close-btn'),
                    messages: document.getElementById('chat-messages'),
                    input: document.getElementById('chat-input'),
                    sendBtn: document.getElementById('send-btn'),
                    status: document.getElementById('chat-status'),
                    consentModal: document.getElementById('consent-modal'),
                    consentAgree: document.getElementById('consent-agree'),
                    consentDecline: document.getElementById('consent-decline'),
                    overlay: document.getElementById('chat-overlay')
                };
            }

            setupEventListeners() {
                // Launcher click
                this.elements.launcher?.addEventListener('click', () => this.handleLauncherClick());
                
                // Close chat
                this.elements.closeBtn?.addEventListener('click', () => this.closeChat());
                
                // Send message
                this.elements.sendBtn?.addEventListener('click', () => this.sendMessage());
                
                // Input handling
                this.elements.input?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.elements.input?.addEventListener('input', () => this.updateSendButton());
                
                // Consent handling
                this.elements.consentAgree?.addEventListener('click', () => this.handleConsent(true));
                this.elements.consentDecline?.addEventListener('click', () => this.handleConsent(false));
                
                // Overlay click
                this.elements.overlay?.addEventListener('click', () => this.closeChat());
            }

            handleLauncherClick() {
                if (this.hasConsent()) {
                    this.openChat();
                } else {
                    this.showConsentModal();
                }
            }

            hasConsent() {
                return localStorage.getItem(this.config.consentKey) === 'true';
            }

            showConsentModal() {
                this.elements.consentModal?.classList.add('show');
                this.elements.consentModal?.setAttribute('aria-hidden', 'false');
            }

            hideConsentModal() {
                this.elements.consentModal?.classList.remove('show');
                this.elements.consentModal?.setAttribute('aria-hidden', 'true');
            }

            handleConsent(agreed) {
                if (agreed) {
                    localStorage.setItem(this.config.consentKey, 'true');
                    this.hideConsentModal();
                    this.openChat();
                } else {
                    this.hideConsentModal();
                }
            }

            async openChat() {
                this.elements.chatWindow?.classList.add('open');
                this.elements.chatWindow?.setAttribute('aria-hidden', 'false');
                this.elements.overlay?.classList.add('show');
                this.elements.input?.focus();
                
                await this.initializeVapi();
            }

            closeChat() {
                this.elements.chatWindow?.classList.remove('open');
                this.elements.chatWindow?.setAttribute('aria-hidden', 'true');
                this.elements.overlay?.classList.remove('show');
                
                if (this.vapi && this.isSessionActive) {
                    this.vapi.stop();
                    this.isSessionActive = false;
                }
            }

            async initializeVapi() {
                if (this.isSessionActive || !Vapi) return;

                try {
                    this.vapi = new Vapi(this.config.publicKey);
                    
                    // Set up event listeners
                    this.vapi.on('message', (message) => this.handleVapiMessage(message));
                    this.vapi.on('error', (error) => this.handleVapiError(error));
                    this.vapi.on('call-start', () => this.handleCallStart());
                    this.vapi.on('call-end', () => this.handleCallEnd());
                    
                    // Start the session
                    await this.vapi.start(this.config.assistantId);
                    this.isSessionActive = true;
                    
                    // Show welcome message
                    this.addMessage('assistant', this.config.welcomeMessage);
                    
                } catch (error) {
                    console.error('Failed to initialize Vapi:', error);
                    this.addMessage('assistant', 'Sorry, I\'m having trouble connecting. Please try again later.');
                }
            }

            handleVapiMessage(data) {
                const { message, text } = data;
                const content = message?.content || text;
                const role = message?.role || 'assistant';
                
                if (content && role !== 'user') {
                    this.addMessage(role, content);
                }
                
                this.hideTypingIndicator();
            }

            handleVapiError(error) {
                console.error('Vapi error:', error);
                this.addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                this.hideTypingIndicator();
            }

            handleCallStart() {
                console.log('Vapi call started');
            }

            handleCallEnd() {
                console.log('Vapi call ended');
                this.isSessionActive = false;
            }

            async sendMessage() {
                const text = this.elements.input?.value?.trim();
                if (!text || !this.vapi || !this.isSessionActive) return;

                this.addMessage('user', text);
                this.elements.input.value = '';
                this.updateSendButton();
                this.showTypingIndicator();

                try {
                    await this.vapi.send({
                        type: 'add-message',
                        message: { role: 'user', content: text }
                    });
                } catch (error) {
                    console.error('Failed to send message:', error);
                    this.addMessage('assistant', 'Sorry, I didn\'t receive your message. Please try again.');
                    this.hideTypingIndicator();
                }
            }

            addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatar = document.createElement('div');
                avatar.className = `${role}-avatar`;
                avatar.textContent = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
                this.elements.messages?.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                const indicator = this.elements.status?.querySelector('.typing-indicator');
                if (indicator) {
                    indicator.style.display = 'inline';
                }
            }

            hideTypingIndicator() {
                const indicator = this.elements.status?.querySelector('.typing-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            updateSendButton() {
                const hasText = this.elements.input?.value?.trim().length > 0;
                if (this.elements.sendBtn) {
                    this.elements.sendBtn.disabled = !hasText;
                }
            }

            scrollToBottom() {
                if (this.elements.messages) {
                    this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
                }
            }
        }

        // Initialize the chat when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (Vapi) {
                new VapiChatManager(VAPI_CONFIG);
            }
        });

        // Initialize immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                new VapiChatManager(VAPI_CONFIG);
            });
        } else {
            new VapiChatManager(VAPI_CONFIG);
        }
    </script>
</body>
</html>